from flask import Flask, request, jsonify, render_template, redirect, url_for
import os
import hashlib

app = Flask(__name__)  
PASTAUPLOAD = 'uploads'
os.makedirs(PASTAUPLOAD, exist_ok=True)
app.config['UPLOAD_FOLDER'] = PASTAUPLOAD  

hashes_conhecidos = {
    'e99a18c428cb38d5f260853678922e03': ['Malware Exemplo A', 'Trojan.Gen'],
    '098f6bcd4621d373cade4e832627b4f6': ['Malware Exemplo B'],
    '5d41402abc4b2a76b9719d911017c592': ['Adware.XYZ', 'Worm.AutoRun'],
    'd41d8cd98f00b204e9800998ecf8427e': ['Virus.TesteArquivo'],
    'f4ed54773bcf7428871834ab9d214273': ['Trojan.Simulado'],
    'a54d88e06612d820bc3be72877c74f257b561b19': ['Backdoor.Win32.Generic'],
    'c157a79031e1c40f85931829bc5fc552': ['Spyware.Keylogger', 'Trojan.RAT'],
    '6a9c98adf77c5eb35e2d429b7a79f4e3': ['Ransomware.CryptoLocker'],
    'ae2b1fca515949e5d54fb22b8ed95575': ['Worm.NetSky'],
    '9e107d9d372bb6826bd81d3542a419d6': ['Exploit.PDF.CVE-2021-12345'],
    '4a8a08f09d37b73795649038408b5f33': ['Malware.Linux.BashScript'],
    'ec8956637a99787bd197eacd77acce5e': ['Virus.Win32.Sality'],
    '7b8b965ad4bca0e41ab51de7b31363a1': ['Adware.PopupBlast'],
    '8f14e45fceea167a5a36dedd4bea2543': ['Trojan.Dropper']
}

def verificar_arquivo(caminho_arquivo):
    with open(caminho_arquivo, 'rb') as f:
        hash_arquivo = hashlib.md5(f.read()).hexdigest()

    if hash_arquivo in hashes_conhecidos:
        lista_malwares = hashes_conhecidos[hash_arquivo]
        return {
            "status": "Malware detectado",
            "descricao": f"Foram encontrados {len(lista_malwares)} tipos de malware",
            "detalhes_malware": lista_malwares
        }
    else:
        return {
            "status": "Arquivo limpo",
            "descricao": "Nenhuma amea√ßa conhecida detectada",
            "detalhes_malware": []
        }

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_arquivo():
    if 'file' not in request.files:
        return redirect(url_for('index', erro="Nenhum arquivo foi enviado"))

    arquivo = request.files['file']

    if arquivo.filename == '':
        return redirect(url_for('index', erro="Nenhum arquivo selecionado"))

    caminho_arquivo = os.path.join(app.config['UPLOAD_FOLDER'], arquivo.filename)
    arquivo.save(caminho_arquivo)

    resultado_verificacao = verificar_arquivo(caminho_arquivo)
    os.remove(caminho_arquivo)

    return render_template('resultado.html', resultado=resultado_verificacao)

if __name__ == '__main__':  
    app.run(host='0.0.0.0', port=5000, debug=True)
